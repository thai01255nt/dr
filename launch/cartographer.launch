<launch>
  <arg name="use_gps" default="true"/>
  <arg name="use_scan_filter" default="true"/>

  <!-- Config file phụ thuộc arg -->
  <arg if="$(arg use_gps)" name="config_basename" value="drone_2d.lua"/>
  <arg unless="$(arg use_gps)" name="config_basename" value="drone_2d_non_gps.lua"/>
  
  <!-- Scan filter node - chỉ chạy khi use_scan_filter=true -->
  <group if="$(arg use_scan_filter)">
    <node name="scan_filter" pkg="laser_filters" type="scan_to_scan_filter_chain">
      <rosparam>
        scan_filter_chain:
        - name: range
          type: laser_filters/LaserScanRangeFilter
          params:
            lower_threshold: 0.5
            upper_threshold: 30
      </rosparam>
      <remap from="scan" to="/scan"/>
      <remap from="scan_filtered" to="/scan_filtered"/>
    </node>
  </group>
  
  <node name="cartographer_node" pkg="cartographer_ros"
        type="cartographer_node"
        args="-configuration_directory $(find cart_teb_test)/config
              -configuration_basename $(arg config_basename)">
    <!-- Scan topic tùy thuộc vào việc có dùng filter hay không -->
    <remap if="$(arg use_scan_filter)" from="scan" to="/scan_filtered"/>
    <remap unless="$(arg use_scan_filter)" from="scan" to="/scan"/>
    <remap from="imu" to="/mavros/imu/data"/>
    <remap from="fix" to="/mavros/global_position/global"/>
    <remap from="odom" to="/mavros/local_position/odom"/>
    <param name="use_sim_time" value="true"/>
  </node>

  <node name="cartographer_occupancy_grid_node"
        pkg="cartographer_ros"
        type="cartographer_occupancy_grid_node"
        args="-resolution 0.05" output="screen"/>
  <node name="robot_pose_publisher"
    pkg="robot_pose_publisher"
    type="robot_pose_publisher"
    respawn="false"
    output="screen" >
    <param name="publish_frequency" type="double" value="50"/>  <!-- 30 Hz cho ArduPilot -->
    <param name="is_stamped" type="bool" value="true"/>
    <param name="map_frame" type="string" value="map"/>
    <param name="base_frame" type="string" value="base_link"/>
    <remap from="robot_pose" to="/mavros/vision_pose/pose"/>
  </node>
</launch>
